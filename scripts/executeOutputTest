#!/bin/bash

VALID_EXAMPLES=(
                "/advanced"
                "/array"
                "/basic"
                "/expressions"
                "/function"
                "/if"
                "/IO"
                "/pairs"
                "/runtimeErr"
                "/scope"
                "/sequence"
                "/variables"
                "/while"
                )

EXECUTE_OUTPUT_DIR="./log/output"
REF_COMPILE="./src/test/examples/refCompile"

LOOK_BEFORE="=========================================================== "
LOOK_AFTER=" ==========================================================="

mkdir log
mkdir $ASSEMBLY_OUTPUT_DIR
mkdir $EXECUTE_OUTPUT_DIR

# counters to represent the total number of test files to be processed
TOTAL_COUNT=$(find "${VALID_EXAMPLES[@]/#/${VALID_EXAMPLES_SRC_DIR}}" -name "*.wacc" | wc -l)
COUNTER=0

for folder in ${VALID_EXAMPLES[@]}; do
  for file in $(find "${EXECUTE_OUTPUT_DIR}${folder}" -name "*.output.txt")
  do
    FILE_NAME=$(basename "${file%.*}")
    EXECUTABLE_OUTPUT_FILE="${EXECUTE_OUTPUT_VALID_FOLDER}/${FILE_NAME}"
    echo $file
    # Generate the result from reference compiler
    REF_COMPILE_RESULT=$(echo $(echo "" | $REF_COMPILE $file -x) | grep -Po "(?<=(${LOOK_BEFORE})).*(?=(${LOOK_AFTER}))")
    # Use the result generated by our compiler
    OUR_RESULT="${EXECUTABLE_OUTPUT_FILE}.output.txt"
    # Compare them to see the differences
    diff <(echo $REF_COMPILE_RESULT) $OUR_RESULT
    ret=$?
    if [ $ret -eq 0 ]; then
      (( COUNTER += 1 ))
    fi
    echo "$COUNTER / $(($TOTAL_COUNT)) files have been executed"
  done

  echo "========================================================================================"
  echo "Test Folder" $folder "has been processed" "($COUNTER / $(($TOTAL_COUNT)))"
  echo "========================================================================================"
done